generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


//////////////////////
// ENUMS
//////////////////////

enum Role {
  ADMIN
  AGENT
  TECHNICIAN
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

//////////////////////
// MODELS
//////////////////////

model User {
  id           String        @id @default(uuid())
  fullName     String
  email        String        @unique
  password     String
  role         Role
  status       UserStatus    @default(ACTIVE)

  assignedTickets Ticket[]   @relation("AssignedTickets")
  ticketUpdates   TicketUpdate[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([role])
}

model Customer {
  id           String     @id @default(uuid())
  fullName     String
  phone        String     @unique
  email        String?
  nationalId   String?
  address      String?
  subscription Subscription?

  tickets      Ticket[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Subscription {
  id           String   @id @default(uuid())
  planName     String
  speedMbps    Int
  price        Float
  isActive     Boolean  @default(true)

  customerId   String   @unique
  customer     Customer @relation(fields: [customerId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Ticket {
  id               String        @id @default(uuid())
  ticketNumber     String        @unique
  description      String
  status           TicketStatus  @default(OPEN)
  priority         Priority

  customerId       String
  assignedToId     String?

  customer         Customer      @relation(fields: [customerId], references: [id])
  assignedTo       User?         @relation("AssignedTickets", fields: [assignedToId], references: [id])

  updates          TicketUpdate[]

  openedAt         DateTime      @default(now())
  resolvedAt       DateTime?
  closedAt         DateTime?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([status])
  @@index([priority])
  @@index([customerId])
}

model TicketUpdate {
  id           String        @id @default(uuid())
  ticketId     String
  userId       String

  previousStatus TicketStatus?
  newStatus      TicketStatus
  note           String

  ticket       Ticket       @relation(fields: [ticketId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  createdAt    DateTime     @default(now())

  @@index([ticketId])
}

//////////////////////
// OPTIONAL (ADVANCED)
//////////////////////

model ActivityLog {
  id          String   @id @default(uuid())
  action      String
  entity      String
  entityId    String
  performedBy String?

  createdAt   DateTime @default(now())

  @@index([entity])
}
